import * as _ from 'lodash';
import { CeUtilsService, genNodeId } from '../services';
export function lockNodes(ids) {
    return (state) => (Object.assign(Object.assign({}, state), { nodes: state.nodes.map((node) => (ids.includes(node.id) ? Object.assign(Object.assign({}, node), { locked: true }) : node)) }));
}
export function unlockNodes(ids) {
    return (state) => (Object.assign(Object.assign({}, state), { nodes: state.nodes.map((node) => (ids.includes(node.id) ? Object.assign(Object.assign({}, node), { locked: false }) : node)) }));
}
export function addNodes(nodes) {
    return (state) => (Object.assign(Object.assign({}, state), { nodes: [...state.nodes, ...nodes] }));
}
export function removeNodes(ids) {
    return (state) => {
        let parent = CeUtilsService.shared.getSameLayerParentByChildren(ids, state.nodes);
        if (parent === false) {
            return Object.assign({}, state);
        }
        else if (parent === undefined) {
            return Object.assign(Object.assign({}, state), { nodes: state.nodes.filter((node) => !ids.includes(node.id)) });
        }
        else {
            const originalParentId = parent.id;
            let prevParent;
            let prevParentId;
            const parents = CeUtilsService.shared.getNodeAndParentListById(parent.id, _.cloneDeep(state.nodes));
            while (parents.length) {
                parent = parents.shift();
                let children;
                if (parent.id === originalParentId) {
                    children = parent.children.filter((child) => !ids.includes(child.id));
                }
                else {
                    children = parent.children
                        .filter((child) => (child.id === prevParentId ? prevParent : child))
                        .filter((child) => !!child);
                }
                prevParentId = parent.id;
                if (children.length > 1) {
                    const rect = CeUtilsService.shared.getOuterBoundingBox(children
                        .map((child) => (Object.assign({ rotate: child.rotate }, CeUtilsService.shared.getChildPositionBaseOnParentCoordinateSystem(parent, parent.rotate, child))))
                        .map((item) => CeUtilsService.shared.getAbsolutePosition(item.cx, item.cy, item.width, item.height, item.rotate)));
                    parent.width = rect.width;
                    parent.height = rect.height;
                    parent.left = rect.left;
                    parent.top = rect.top;
                    parent.children = children;
                }
                else if (children.length === 1) {
                    const rect = CeUtilsService.shared.getChildPositionBaseOnParentCoordinateSystem(parent, parent.rotate, children[0]);
                    parent = Object.assign(Object.assign({}, children[0]), rect);
                }
                else if (children.length === 0) {
                    parent = null;
                }
                prevParent = parent;
            }
            return Object.assign(Object.assign({}, state), { nodes: state.nodes.map((node) => (node.id === prevParentId ? parent : node)).filter((node) => !!node) });
        }
    };
}
export function updateNodes(nodes) {
    return (state) => (Object.assign(Object.assign({}, state), { nodes: state.nodes.map((item) => (Object.assign(Object.assign({}, item), nodes.find((i) => i.id === item.id)))) }));
}
export function updateNodesSize(nodesSizeMap) {
    return (state) => {
        var _a;
        let inSameLayer = true;
        const ids = [...nodesSizeMap.keys()];
        let parent;
        while (inSameLayer && ids.length) {
            const id = ids.pop();
            const node = CeUtilsService.shared.getNodeById(id, state.nodes);
            inSameLayer = (parent === null || parent === void 0 ? void 0 : parent.id) === ((_a = node.parentNode) === null || _a === void 0 ? void 0 : _a.id);
            parent = node.parentNode;
        }
        if (!inSameLayer) {
            return state;
        }
        else {
            if (!parent) {
                return Object.assign(Object.assign({}, state), { nodes: state.nodes.map((node) => {
                        const newNode = Object.assign(Object.assign({}, node), nodesSizeMap.get(node.id));
                        if (node.children && node.children.length) {
                            return Object.assign(Object.assign({}, newNode), { children: recursiveUpdateNodeChildrenSize(newNode.children, Object.assign({}, node), Object.assign({}, newNode)) });
                        }
                        else {
                            return newNode;
                        }
                    }) });
            }
            else {
                return state;
            }
        }
    };
}
export function groupNodes(ids) {
    return (state) => {
        const parent = CeUtilsService.shared.getSameLayerParentByChildren(ids, state.nodes);
        if (parent === false) {
            return state;
        }
        const nodeMap = new Map();
        ids.forEach((id) => {
            const node = state.nodes.find((i) => i.id === id);
            if (node) {
                nodeMap.set(id, node);
            }
        });
        const groupRect = CeUtilsService.shared.getOuterBoundingBox(ids
            .filter((id) => nodeMap.has(id))
            .map((id) => {
            const node = nodeMap.get(id);
            return CeUtilsService.shared.getAbsolutePosition(node.left + node.width / 2, node.top + node.height / 2, node.width, node.height, node.rotate);
        }));
        const groupNode = Object.assign(Object.assign({ id: genNodeId(), name: 'Group' }, groupRect), { rotate: 0, zIndex: Math.max(...state.nodes.filter((node) => !nodeMap.has(node.id)).map((node) => node.zIndex)) + 1, children: ids
                .filter((id) => nodeMap.has(id))
                .map((id) => {
                const node = nodeMap.get(id);
                const { bl, br, tl, tr } = CeUtilsService.shared.getAbsolutePosition(node.left + node.width / 2, node.top + node.height / 2, node.width, node.height, node.rotate);
                return Object.assign(Object.assign({}, node), CeUtilsService.shared.getRelativePosition({
                    bl: [bl[0] - groupRect.left, bl[1] - groupRect.top],
                    br: [br[0] - groupRect.left, br[1] - groupRect.top],
                    tl: [tl[0] - groupRect.left, tl[1] - groupRect.top],
                    tr: [tr[0] - groupRect.left, tr[1] - groupRect.top],
                }));
            }) });
        return Object.assign(Object.assign({}, state), { nodes: [...state.nodes.filter((node) => !nodeMap.has(node.id)), groupNode] });
    };
}
export function breakNode(id) {
    return (state) => {
        const [node, ...parents] = CeUtilsService.shared.getNodeAndParentListById(id, _.cloneDeep(state.nodes));
        const newNodes = node.children.map((child) => {
            var _a, _b;
            return Object.assign(Object.assign(Object.assign({}, child), CeUtilsService.shared.getChildPositionBaseOnParentCoordinateSystem(node, node.rotate, child)), { rotate: ((_a = child.rotate) !== null && _a !== void 0 ? _a : 0) + ((_b = node.rotate) !== null && _b !== void 0 ? _b : 0) });
        });
        if (!parents.length) {
            return Object.assign(Object.assign({}, state), { nodes: [...state.nodes.filter((i) => i.id !== node.id), ...newNodes] });
        }
        else {
            let parent = parents.shift();
            parent.children = [...parent.children.filter((child) => child.id !== node.id), ...newNodes];
            while (parents.length) {
                const nextParent = parents.shift();
                nextParent.children = nextParent.children.map((child) => (child.id === parent.id ? parent : child));
                parent = nextParent;
            }
            return Object.assign(Object.assign({}, state), { nodes: [...state.nodes.filter((i) => i.id !== parent.id), parent] });
        }
    };
}
// /**
//  * 递归更新节点的位置和大小
//  * @param nodes 节点列表
//  * @param oldParentRect 父节点的旧尺寸和位置
//  * @param newParentRect 父节点的新尺寸和位置
//  */
// function recursiveUpdateNodeChildrenSize(nodes: INode[], oldParentRect: IDOMRect, newParentRect: IDOMRect): INode[] {
//   const { width, height } = newParentRect;
//   return nodes.map((node) => {
//     const cxPercent = (node.left + node.width / 2) / oldParentRect.width;
//     const cyPercent = (node.top + node.height / 2) / oldParentRect.height;
//     const widthPercent = node.width / oldParentRect.width;
//     const heightPercent = node.height / oldParentRect.height;
//     const newNodeRect: IDOMRect = {
//       width: widthPercent * width,
//       height: heightPercent * height,
//       left: cxPercent * width - (widthPercent * width) / 2,
//       top: cyPercent * height - (heightPercent * height) / 2,
//     };
//     if (node.children && node.children.length) {
//       return { ...node, ...newNodeRect, children: recursiveUpdateNodeChildrenSize(node.children, { ...node }, { ...newNodeRect }) };
//     } else {
//       return { ...node, ...newNodeRect };
//     }
//   });
// }
/**
 * 递归更新节点的位置和大小
 * @param nodes 节点列表
 * @param oldParentRect 父节点的旧尺寸和位置
 * @param newParentRect 父节点的新尺寸和位置
 */
function recursiveUpdateNodeChildrenSize(nodes, oldParentRect, newParentRect) {
    const { width, height } = newParentRect;
    return nodes.map((node) => {
        const nodeAbsolutePosition = CeUtilsService.shared.getAbsolutePosition(node.left + node.width / 2, node.top + node.height / 2, node.width, node.height, node.rotate);
        const { tl, tr, bl, br } = CeUtilsService.shared.getItemPercentPositionInGroup(Object.assign(Object.assign({}, oldParentRect), { left: 0, top: 0 }), nodeAbsolutePosition);
        const newNodeRect = CeUtilsService.shared.getRelativePosition({
            tl: [tl[0] * width, tl[1] * height],
            tr: [tr[0] * width, tr[1] * height],
            bl: [bl[0] * width, bl[1] * height],
            br: [br[0] * width, br[1] * height],
        });
        if (node.children && node.children.length) {
            return Object.assign(Object.assign(Object.assign({}, node), newNodeRect), { children: recursiveUpdateNodeChildrenSize(node.children, Object.assign({}, node), Object.assign({}, newNodeRect)) });
        }
        else {
            return Object.assign(Object.assign({}, node), newNodeRect);
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZXMuYWN0aW9ucy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyLWVkaXRvci1saWIvc3JjLyIsInNvdXJjZXMiOlsibGliL2FjdGlvbnMvbm9kZXMuYWN0aW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssQ0FBQyxNQUFNLFFBQVEsQ0FBQztBQUM1QixPQUFPLEVBQUUsY0FBYyxFQUFFLFNBQVMsRUFBWSxNQUFNLGFBQWEsQ0FBQztBQUdsRSxNQUFNLFVBQVUsU0FBUyxDQUFVLEdBQWE7SUFDOUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsaUNBQU0sS0FBSyxLQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLGlDQUFNLElBQUksS0FBRSxNQUFNLEVBQUUsSUFBSSxJQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFHLENBQUM7QUFDakksQ0FBQztBQUVELE1BQU0sVUFBVSxXQUFXLENBQVUsR0FBYTtJQUNoRCxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxpQ0FBTSxLQUFLLEtBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsaUNBQU0sSUFBSSxLQUFFLE1BQU0sRUFBRSxLQUFLLElBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUcsQ0FBQztBQUNsSSxDQUFDO0FBRUQsTUFBTSxVQUFVLFFBQVEsQ0FBVSxLQUFpQjtJQUNqRCxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxpQ0FBTSxLQUFLLEtBQUUs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LEtBQUUsUUFBUSxFQUFFLCtCQUErQixDQUFDLElBQUksQ0FBQyxRQUFRLG9CQUFPLElBQUkscUJBQVMsV0FBVyxFQUFHLElBQUc7U0FDL0g7YUFBTTtZQUNMLHVDQUFZLElBQUksR0FBSyxXQUFXLEVBQUc7U0FDcEM7SUFDSCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBDZVV0aWxzU2VydmljZSwgZ2VuTm9kZUlkLCBJRE9NUmVjdCB9IGZyb20gJy4uL3NlcnZpY2VzJztcbmltcG9ydCB7IElBY3Rpb25UeXBlLCBJTm9kZSB9IGZyb20gJy4uL3N0b3JlJztcblxuZXhwb3J0IGZ1bmN0aW9uIGxvY2tOb2RlczxUID0gYW55PihpZHM6IHN0cmluZ1tdKTogSUFjdGlvblR5cGU8VD4ge1xuICByZXR1cm4gKHN0YXRlKSA9PiAoeyAuLi5zdGF0ZSwgbm9kZXM6IHN0YXRlLm5vZGVzLm1hcCgobm9kZSkgPT4gKGlkcy5pbmNsdWRlcyhub2RlLmlkKSA/IHsgLi4ubm9kZSwgbG9ja2VkOiB0cnVlIH0gOiBub2RlKSkgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1bmxvY2tOb2RlczxUID0gYW55PihpZHM6IHN0cmluZ1tdKTogSUFjdGlvblR5cGU8VD4ge1xuICByZXR1cm4gKHN0YXRlKSA9PiAoeyAuLi5zdGF0ZSwgbm9kZXM6IHN0YXRlLm5vZGVzLm1hcCgobm9kZSkgPT4gKGlkcy5pbmNsdWRlcyhub2RlLmlkKSA/IHsgLi4ubm9kZSwgbG9ja2VkOiBmYWxzZSB9IDogbm9kZSkpIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYWRkTm9kZXM8VCA9IGFueT4obm9kZXM6IElOb2RlPFQ+W10pOiBJQWN0aW9uVHlwZTxUPiB7XG4gIHJldHVybiAoc3RhdGUpID0+ICh7IC4uLnN0YXRlLCBub2RlczogWy4uLnN0YXRlLm5vZGVzLCAuLi5ub2Rlc10gfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW1vdmVOb2RlczxUID0gYW55PihpZHM6IHN0cmluZ1tdKTogSUFjdGlvblR5cGU8VD4ge1xuICByZXR1cm4gKHN0YXRlKSA9PiB7XG4gICAgbGV0IHBhcmVudCA9IENlVXRpbHNTZXJ2aWNlLnNoYXJlZC5nZXRTYW1lTGF5ZXJQYXJlbnRCeUNoaWxkcmVuKGlkcywgc3RhdGUubm9kZXMpO1xuICAgIGlmIChwYXJlbnQgPT09IGZhbHNlKSB7XG4gICAgICByZXR1cm4geyAuLi5zdGF0ZSB9O1xuICAgIH0gZWxzZSBpZiAocGFyZW50ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiB7IC4uLnN0YXRlLCBub2Rlczogc3RhdGUubm9kZXMuZmlsdGVyKChub2RlKSA9PiAhaWRzLmluY2x1ZGVzKG5vZGUuaWQpKSB9O1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBvcmlnaW5hbFBhcmVudElkID0gcGFyZW50LmlkO1xuICAgICAgbGV0IHByZXZQYXJlbnQ6IElOb2RlO1xuICAgICAgbGV0IHByZXZQYXJlbnRJZDogc3RyaW5nO1xuICAgICAgY29uc3QgcGFyZW50cyA9IENlVXRpbHNTZXJ2aWNlLnNoYXJlZC5nZXROb2RlQW5kUGFyZW50TGlzdEJ5SWQocGFyZW50LmlkLCBfLmNsb25lRGVlcChzdGF0ZS5ub2RlcykpO1xuICAgICAgd2hpbGUgKHBhcmVudHMubGVuZ3RoKSB7XG4gICAgICAgIHBhcmVudCA9IHBhcmVudHMuc2hpZnQoKTtcbiAgICAgICAgbGV0IGNoaWxkcmVuOiBJTm9kZTxUPltdO1xuICAgICAgICBpZiAocGFyZW50LmlkID09PSBvcmlnaW5hbFBhcmVudElkKSB7XG4gICAgICAgICAgY2hpbGRyZW4gPSBwYXJlbnQuY2hpbGRyZW4uZmlsdGVyKChjaGlsZDogSU5vZGU8VD4pID0+ICFpZHMuaW5jbHVkZXMoY2hpbGQuaWQpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjaGlsZHJlbiA9IHBhcmVudC5jaGlsZHJlblxuICAgICAgICAgICAgLmZpbHRlcigoY2hpbGQ6IElOb2RlPFQ+KSA9PiAoY2hpbGQuaWQgPT09IHByZXZQYXJlbnRJZCA/IHByZXZQYXJlbnQgOiBjaGlsZCkpXG4gICAgICAgICAgICAuZmlsdGVyKChjaGlsZDogSU5vZGU8VD4pID0+ICEhY2hpbGQpO1xuICAgICAgICB9XG4gICAgICAgIHByZXZQYXJlbnRJZCA9IHBhcmVudC5pZDtcbiAgICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICBjb25zdCByZWN0ID0gQ2VVdGlsc1NlcnZpY2Uuc2hhcmVkLmdldE91dGVyQm91bmRpbmdCb3goXG4gICAgICAgICAgICBjaGlsZHJlblxuICAgICAgICAgICAgICAubWFwKChjaGlsZCkgPT4gKHtcbiAgICAgICAgICAgICAgICByb3RhdGU6IGNoaWxkLnJvdGF0ZSxcbiAgICAgICAgICAgICAgICAuLi5DZVV0aWxzU2VydmljZS5zaGFyZWQuZ2V0Q2hpbGRQb3NpdGlvbkJhc2VPblBhcmVudENvb3JkaW5hdGVTeXN0ZW0ocGFyZW50IGFzIElOb2RlLCAocGFyZW50IGFzIElOb2RlKS5yb3RhdGUsIGNoaWxkKSxcbiAgICAgICAgICAgICAgfSkpXG4gICAgICAgICAgICAgIC5tYXAoKGl0ZW0pID0+IENlVXRpbHNTZXJ2aWNlLnNoYXJlZC5nZXRBYnNvbHV0ZVBvc2l0aW9uKGl0ZW0uY3gsIGl0ZW0uY3ksIGl0ZW0ud2lkdGgsIGl0ZW0uaGVpZ2h0LCBpdGVtLnJvdGF0ZSkpXG4gICAgICAgICAgKTtcbiAgICAgICAgICBwYXJlbnQud2lkdGggPSByZWN0LndpZHRoO1xuICAgICAgICAgIHBhcmVudC5oZWlnaHQgPSByZWN0LmhlaWdodDtcbiAgICAgICAgICBwYXJlbnQubGVmdCA9IHJlY3QubGVmdDtcbiAgICAgICAgICBwYXJlbnQudG9wID0gcmVjdC50b3A7XG4gICAgICAgICAgcGFyZW50LmNoaWxkcmVuID0gY2hpbGRyZW47XG4gICAgICAgIH0gZWxzZSBpZiAoY2hpbGRyZW4ubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgY29uc3QgcmVjdCA9IENlVXRpbHNTZXJ2aWNlLnNoYXJlZC5nZXRDaGlsZFBvc2l0aW9uQmFzZU9uUGFyZW50Q29vcmRpbmF0ZVN5c3RlbShwYXJlbnQsIHBhcmVudC5yb3RhdGUsIGNoaWxkcmVuWzBdKTtcbiAgICAgICAgICBwYXJlbnQgPSB7IC4uLmNoaWxkcmVuWzBdLCAuLi5yZWN0IH07XG4gICAgICAgIH0gZWxzZSBpZiAoY2hpbGRyZW4ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgcGFyZW50ID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBwcmV2UGFyZW50ID0gcGFyZW50IGFzIElOb2RlO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHsgLi4uc3RhdGUsIG5vZGVzOiBzdGF0ZS5ub2Rlcy5tYXAoKG5vZGUpID0+IChub2RlLmlkID09PSBwcmV2UGFyZW50SWQgPyBwYXJlbnQgOiBub2RlKSkuZmlsdGVyKChub2RlKSA9PiAhIW5vZGUpIGFzIElOb2RlPFQ+W10gfTtcbiAgICB9XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVOb2RlczxUID0gYW55Pihub2RlczogSU5vZGU8VD5bXSk6IElBY3Rpb25UeXBlPFQ+IHtcbiAgcmV0dXJuIChzdGF0ZSkgPT4gKHsgLi4uc3RhdGUsIG5vZGVzOiBzdGF0ZS5ub2Rlcy5tYXAoKGl0ZW0pID0+ICh7IC4uLml0ZW0sIC4uLm5vZGVzLmZpbmQoKGkpID0+IGkuaWQgPT09IGl0ZW0uaWQpIH0pKSB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZU5vZGVzU2l6ZTxUID0gYW55Pihub2Rlc1NpemVNYXA6IE1hcDxzdHJpbmcsIElET01SZWN0Pik6IElBY3Rpb25UeXBlPFQ+IHtcbiAgcmV0dXJuIChzdGF0ZSkgPT4ge1xuICAgIGxldCBpblNhbWVMYXllciA9IHRydWU7XG4gICAgY29uc3QgaWRzID0gWy4uLm5vZGVzU2l6ZU1hcC5rZXlzKCldO1xuICAgIGxldCBwYXJlbnQ6IElOb2RlO1xuICAgIHdoaWxlIChpblNhbWVMYXllciAmJiBpZHMubGVuZ3RoKSB7XG4gICAgICBjb25zdCBpZCA9IGlkcy5wb3AoKTtcbiAgICAgIGNvbnN0IG5vZGUgPSBDZVV0aWxzU2VydmljZS5zaGFyZWQuZ2V0Tm9kZUJ5SWQoaWQsIHN0YXRlLm5vZGVzKTtcbiAgICAgIGluU2FtZUxheWVyID0gcGFyZW50Py5pZCA9PT0gbm9kZS5wYXJlbnROb2RlPy5pZDtcbiAgICAgIHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTtcbiAgICB9XG5cbiAgICBpZiAoIWluU2FtZUxheWVyKSB7XG4gICAgICByZXR1cm4gc3RhdGU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghcGFyZW50KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgICAgbm9kZXM6IHN0YXRlLm5vZGVzLm1hcCgobm9kZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbmV3Tm9kZSA9IHsgLi4ubm9kZSwgLi4ubm9kZXNTaXplTWFwLmdldChub2RlLmlkKSB9O1xuICAgICAgICAgICAgaWYgKG5vZGUuY2hpbGRyZW4gJiYgbm9kZS5jaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHsgLi4ubmV3Tm9kZSwgY2hpbGRyZW46IHJlY3Vyc2l2ZVVwZGF0ZU5vZGVDaGlsZHJlblNpemUobmV3Tm9kZS5jaGlsZHJlbiwgeyAuLi5ub2RlIH0sIHsgLi4ubmV3Tm9kZSB9KSB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIG5ld05vZGU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSksXG4gICAgICAgIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gc3RhdGU7XG4gICAgICB9XG4gICAgfVxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ3JvdXBOb2RlczxUID0gYW55PihpZHM6IHN0cmluZ1tdKTogSUFjdGlvblR5cGU8VD4ge1xuICByZXR1cm4gKHN0YXRlKSA9PiB7XG4gICAgY29uc3QgcGFyZW50ID0gQ2VVdGlsc1NlcnZpY2Uuc2hhcmVkLmdldFNhbWVMYXllclBhcmVudEJ5Q2hpbGRyZW4oaWRzLCBzdGF0ZS5ub2Rlcyk7XG4gICAgaWYgKHBhcmVudCA9PT0gZmFsc2UpIHtcbiAgICAgIHJldHVybiBzdGF0ZTtcbiAgICB9XG4gICAgY29uc3Qgbm9kZU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBJTm9kZT4oKTtcbiAgICBpZHMuZm9yRWFjaCgoaWQpID0+IHtcbiAgICAgIGNvbnN0IG5vZGUgPSBzdGF0ZS5ub2Rlcy5maW5kKChpKSA9PiBpLmlkID09PSBpZCk7XG4gICAgICBpZiAobm9kZSkge1xuICAgICAgICBub2RlTWFwLnNldChpZCwgbm9kZSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgY29uc3QgZ3JvdXBSZWN0ID0gQ2VVdGlsc1NlcnZpY2Uuc2hhcmVkLmdldE91dGVyQm91bmRpbmdCb3goXG4gICAgICBpZHNcbiAgICAgICAgLmZpbHRlcigoaWQpID0+IG5vZGVNYXAuaGFzKGlkKSlcbiAgICAgICAgLm1hcCgoaWQpID0+IHtcbiAgICAgICAgICBjb25zdCBub2RlID0gbm9kZU1hcC5nZXQoaWQpO1xuICAgICAgICAgIHJldHVybiBDZVV0aWxzU2VydmljZS5zaGFyZWQuZ2V0QWJzb2x1dGVQb3NpdGlvbihcbiAgICAgICAgICAgIG5vZGUubGVmdCArIG5vZGUud2lkdGggLyAyLFxuICAgICAgICAgICAgbm9kZS50b3AgKyBub2RlLmhlaWdodCAvIDIsXG4gICAgICAgICAgICBub2RlLndpZHRoLFxuICAgICAgICAgICAgbm9kZS5oZWlnaHQsXG4gICAgICAgICAgICBub2RlLnJvdGF0ZVxuICAgICAgICAgICk7XG4gICAgICAgIH0pXG4gICAgKTtcbiAgICBjb25zdCBncm91cE5vZGU6IElOb2RlID0ge1xuICAgICAgaWQ6IGdlbk5vZGVJZCgpLFxuICAgICAgbmFtZTogJ0dyb3VwJyxcbiAgICAgIC4uLmdyb3VwUmVjdCxcbiAgICAgIHJvdGF0ZTogMCxcbiAgICAgIHpJbmRleDogTWF0aC5tYXgoLi4uc3RhdGUubm9kZXMuZmlsdGVyKChub2RlKSA9PiAhbm9kZU1hcC5oYXMobm9kZS5pZCkpLm1hcCgobm9kZSkgPT4gbm9kZS56SW5kZXgpKSArIDEsXG4gICAgICBjaGlsZHJlbjogaWRzXG4gICAgICAgIC5maWx0ZXIoKGlkKSA9PiBub2RlTWFwLmhhcyhpZCkpXG4gICAgICAgIC5tYXAoKGlkKSA9PiB7XG4gICAgICAgICAgY29uc3Qgbm9kZSA9IG5vZGVNYXAuZ2V0KGlkKTtcbiAgICAgICAgICBjb25zdCB7IGJsLCBiciwgdGwsIHRyIH0gPSBDZVV0aWxzU2VydmljZS5zaGFyZWQuZ2V0QWJzb2x1dGVQb3NpdGlvbihcbiAgICAgICAgICAgIG5vZGUubGVmdCArIG5vZGUud2lkdGggLyAyLFxuICAgICAgICAgICAgbm9kZS50b3AgKyBub2RlLmhlaWdodCAvIDIsXG4gICAgICAgICAgICBub2RlLndpZHRoLFxuICAgICAgICAgICAgbm9kZS5oZWlnaHQsXG4gICAgICAgICAgICBub2RlLnJvdGF0ZVxuICAgICAgICAgICk7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIC4uLm5vZGUsXG4gICAgICAgICAgICAuLi5DZVV0aWxzU2VydmljZS5zaGFyZWQuZ2V0UmVsYXRpdmVQb3NpdGlvbih7XG4gICAgICAgICAgICAgIGJsOiBbYmxbMF0gLSBncm91cFJlY3QubGVmdCwgYmxbMV0gLSBncm91cFJlY3QudG9wXSxcbiAgICAgICAgICAgICAgYnI6IFticlswXSAtIGdyb3VwUmVjdC5sZWZ0LCBiclsxXSAtIGdyb3VwUmVjdC50b3BdLFxuICAgICAgICAgICAgICB0bDogW3RsWzBdIC0gZ3JvdXBSZWN0LmxlZnQsIHRsWzFdIC0gZ3JvdXBSZWN0LnRvcF0sXG4gICAgICAgICAgICAgIHRyOiBbdHJbMF0gLSBncm91cFJlY3QubGVmdCwgdHJbMV0gLSBncm91cFJlY3QudG9wXSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH07XG4gICAgICAgIH0pLFxuICAgIH07XG4gICAgcmV0dXJuIHsgLi4uc3RhdGUsIG5vZGVzOiBbLi4uc3RhdGUubm9kZXMuZmlsdGVyKChub2RlKSA9PiAhbm9kZU1hcC5oYXMobm9kZS5pZCkpLCBncm91cE5vZGVdIH07XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBicmVha05vZGU8VCA9IGFueT4oaWQ6IHN0cmluZyk6IElBY3Rpb25UeXBlPFQ+IHtcbiAgcmV0dXJuIChzdGF0ZSkgPT4ge1xuICAgIGNvbnN0IFtub2RlLCAuLi5wYXJlbnRzXSA9IENlVXRpbHNTZXJ2aWNlLnNoYXJlZC5nZXROb2RlQW5kUGFyZW50TGlzdEJ5SWQoaWQsIF8uY2xvbmVEZWVwKHN0YXRlLm5vZGVzKSk7XG4gICAgY29uc3QgbmV3Tm9kZXMgPSBub2RlLmNoaWxkcmVuLm1hcCgoY2hpbGQ6IElOb2RlPFQ+KSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5jaGlsZCxcbiAgICAgICAgLi4uQ2VVdGlsc1NlcnZpY2Uuc2hhcmVkLmdldENoaWxkUG9zaXRpb25CYXNlT25QYXJlbnRDb29yZGluYXRlU3lzdGVtKG5vZGUsIG5vZGUucm90YXRlLCBjaGlsZCksXG4gICAgICAgIHJvdGF0ZTogKGNoaWxkLnJvdGF0ZSA/PyAwKSArIChub2RlLnJvdGF0ZSA/PyAwKSxcbiAgICAgIH07XG4gICAgfSk7XG4gICAgaWYgKCFwYXJlbnRzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHsgLi4uc3RhdGUsIG5vZGVzOiBbLi4uc3RhdGUubm9kZXMuZmlsdGVyKChpKSA9PiBpLmlkICE9PSBub2RlLmlkKSwgLi4ubmV3Tm9kZXNdIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBwYXJlbnQgPSBwYXJlbnRzLnNoaWZ0KCk7XG4gICAgICBwYXJlbnQuY2hpbGRyZW4gPSBbLi4ucGFyZW50LmNoaWxkcmVuLmZpbHRlcigoY2hpbGQ6IElOb2RlPFQ+KSA9PiBjaGlsZC5pZCAhPT0gbm9kZS5pZCksIC4uLm5ld05vZGVzXTtcbiAgICAgIHdoaWxlIChwYXJlbnRzLmxlbmd0aCkge1xuICAgICAgICBjb25zdCBuZXh0UGFyZW50ID0gcGFyZW50cy5zaGlmdCgpO1xuICAgICAgICBuZXh0UGFyZW50LmNoaWxkcmVuID0gbmV4dFBhcmVudC5jaGlsZHJlbi5tYXAoKGNoaWxkOiBJTm9kZTxUPikgPT4gKGNoaWxkLmlkID09PSBwYXJlbnQuaWQgPyBwYXJlbnQgOiBjaGlsZCkpO1xuICAgICAgICBwYXJlbnQgPSBuZXh0UGFyZW50O1xuICAgICAgfVxuICAgICAgcmV0dXJuIHsgLi4uc3RhdGUsIG5vZGVzOiBbLi4uc3RhdGUubm9kZXMuZmlsdGVyKChpKSA9PiBpLmlkICE9PSBwYXJlbnQuaWQpLCBwYXJlbnRdIH07XG4gICAgfVxuICB9O1xufVxuXG4vLyAvKipcbi8vICAqIOmAkuW9kuabtOaWsOiKgueCueeahOS9jee9ruWSjOWkp+Wwj1xuLy8gICogQHBhcmFtIG5vZGVzIOiKgueCueWIl+ihqFxuLy8gICogQHBhcmFtIG9sZFBhcmVudFJlY3Qg54i26IqC54K555qE5pen5bC65a+45ZKM5L2N572uXG4vLyAgKiBAcGFyYW0gbmV3UGFyZW50UmVjdCDniLboioLngrnnmoTmlrDlsLrlr7jlkozkvY3nva5cbi8vICAqL1xuLy8gZnVuY3Rpb24gcmVjdXJzaXZlVXBkYXRlTm9kZUNoaWxkcmVuU2l6ZShub2RlczogSU5vZGVbXSwgb2xkUGFyZW50UmVjdDogSURPTVJlY3QsIG5ld1BhcmVudFJlY3Q6IElET01SZWN0KTogSU5vZGVbXSB7XG4vLyAgIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gbmV3UGFyZW50UmVjdDtcbi8vICAgcmV0dXJuIG5vZGVzLm1hcCgobm9kZSkgPT4ge1xuLy8gICAgIGNvbnN0IGN4UGVyY2VudCA9IChub2RlLmxlZnQgKyBub2RlLndpZHRoIC8gMikgLyBvbGRQYXJlbnRSZWN0LndpZHRoO1xuLy8gICAgIGNvbnN0IGN5UGVyY2VudCA9IChub2RlLnRvcCArIG5vZGUuaGVpZ2h0IC8gMikgLyBvbGRQYXJlbnRSZWN0LmhlaWdodDtcbi8vICAgICBjb25zdCB3aWR0aFBlcmNlbnQgPSBub2RlLndpZHRoIC8gb2xkUGFyZW50UmVjdC53aWR0aDtcbi8vICAgICBjb25zdCBoZWlnaHRQZXJjZW50ID0gbm9kZS5oZWlnaHQgLyBvbGRQYXJlbnRSZWN0LmhlaWdodDtcbi8vICAgICBjb25zdCBuZXdOb2RlUmVjdDogSURPTVJlY3QgPSB7XG4vLyAgICAgICB3aWR0aDogd2lkdGhQZXJjZW50ICogd2lkdGgsXG4vLyAgICAgICBoZWlnaHQ6IGhlaWdodFBlcmNlbnQgKiBoZWlnaHQsXG4vLyAgICAgICBsZWZ0OiBjeFBlcmNlbnQgKiB3aWR0aCAtICh3aWR0aFBlcmNlbnQgKiB3aWR0aCkgLyAyLFxuLy8gICAgICAgdG9wOiBjeVBlcmNlbnQgKiBoZWlnaHQgLSAoaGVpZ2h0UGVyY2VudCAqIGhlaWdodCkgLyAyLFxuLy8gICAgIH07XG4vLyAgICAgaWYgKG5vZGUuY2hpbGRyZW4gJiYgbm9kZS5jaGlsZHJlbi5sZW5ndGgpIHtcbi8vICAgICAgIHJldHVybiB7IC4uLm5vZGUsIC4uLm5ld05vZGVSZWN0LCBjaGlsZHJlbjogcmVjdXJzaXZlVXBkYXRlTm9kZUNoaWxkcmVuU2l6ZShub2RlLmNoaWxkcmVuLCB7IC4uLm5vZGUgfSwgeyAuLi5uZXdOb2RlUmVjdCB9KSB9O1xuLy8gICAgIH0gZWxzZSB7XG4vLyAgICAgICByZXR1cm4geyAuLi5ub2RlLCAuLi5uZXdOb2RlUmVjdCB9O1xuLy8gICAgIH1cbi8vICAgfSk7XG4vLyB9XG5cbi8qKlxuICog6YCS5b2S5pu05paw6IqC54K555qE5L2N572u5ZKM5aSn5bCPXG4gKiBAcGFyYW0gbm9kZXMg6IqC54K55YiX6KGoXG4gKiBAcGFyYW0gb2xkUGFyZW50UmVjdCDniLboioLngrnnmoTml6flsLrlr7jlkozkvY3nva5cbiAqIEBwYXJhbSBuZXdQYXJlbnRSZWN0IOeItuiKgueCueeahOaWsOWwuuWvuOWSjOS9jee9rlxuICovXG5mdW5jdGlvbiByZWN1cnNpdmVVcGRhdGVOb2RlQ2hpbGRyZW5TaXplKG5vZGVzOiBJTm9kZVtdLCBvbGRQYXJlbnRSZWN0OiBJRE9NUmVjdCwgbmV3UGFyZW50UmVjdDogSURPTVJlY3QpOiBJTm9kZVtdIHtcbiAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSBuZXdQYXJlbnRSZWN0O1xuICByZXR1cm4gbm9kZXMubWFwKChub2RlKSA9PiB7XG4gICAgY29uc3Qgbm9kZUFic29sdXRlUG9zaXRpb24gPSBDZVV0aWxzU2VydmljZS5zaGFyZWQuZ2V0QWJzb2x1dGVQb3NpdGlvbihcbiAgICAgIG5vZGUubGVmdCArIG5vZGUud2lkdGggLyAyLFxuICAgICAgbm9kZS50b3AgKyBub2RlLmhlaWdodCAvIDIsXG4gICAgICBub2RlLndpZHRoLFxuICAgICAgbm9kZS5oZWlnaHQsXG4gICAgICBub2RlLnJvdGF0ZVxuICAgICk7XG4gICAgY29uc3QgeyB0bCwgdHIsIGJsLCBiciB9ID0gQ2VVdGlsc1NlcnZpY2Uuc2hhcmVkLmdldEl0ZW1QZXJjZW50UG9zaXRpb25Jbkdyb3VwKFxuICAgICAge1xuICAgICAgICAuLi5vbGRQYXJlbnRSZWN0LFxuICAgICAgICBsZWZ0OiAwLFxuICAgICAgICB0b3A6IDAsXG4gICAgICB9LFxuICAgICAgbm9kZUFic29sdXRlUG9zaXRpb25cbiAgICApO1xuICAgIGNvbnN0IG5ld05vZGVSZWN0ID0gQ2VVdGlsc1NlcnZpY2Uuc2hhcmVkLmdldFJlbGF0aXZlUG9zaXRpb24oe1xuICAgICAgdGw6IFt0bFswXSAqIHdpZHRoLCB0bFsxXSAqIGhlaWdodF0sXG4gICAgICB0cjogW3RyWzBdICogd2lkdGgsIHRyWzFdICogaGVpZ2h0XSxcbiAgICAgIGJsOiBbYmxbMF0gKiB3aWR0aCwgYmxbMV0gKiBoZWlnaHRdLFxuICAgICAgYnI6IFticlswXSAqIHdpZHRoLCBiclsxXSAqIGhlaWdodF0sXG4gICAgfSk7XG4gICAgaWYgKG5vZGUuY2hpbGRyZW4gJiYgbm9kZS5jaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgIHJldHVybiB7IC4uLm5vZGUsIC4uLm5ld05vZGVSZWN0LCBjaGlsZHJlbjogcmVjdXJzaXZlVXBkYXRlTm9kZUNoaWxkcmVuU2l6ZShub2RlLmNoaWxkcmVuLCB7IC4uLm5vZGUgfSwgeyAuLi5uZXdOb2RlUmVjdCB9KSB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4geyAuLi5ub2RlLCAuLi5uZXdOb2RlUmVjdCB9O1xuICAgIH1cbiAgfSk7XG59XG4iXX0=