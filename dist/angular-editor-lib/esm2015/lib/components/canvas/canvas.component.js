import { __rest } from "tslib";
import { ChangeDetectionStrategy, Component, ViewEncapsulation } from '@angular/core';
import { addBorderedNodes, addSelectedNodes, clearBordered, clearSelected, removeBorderedNodes, resetRefLineState, updateNodes, updateRefLinesState, } from '../../actions';
import * as i0 from "@angular/core";
import * as i1 from "../../services";
import * as i2 from "../../services/utils.service";
import * as i3 from "@angular/common";
import * as i4 from "../box-item/box-item.component";
import * as i5 from "../../directives/draggable.directive";
function CanvasComponent_ce_box_item_0_Template(rf, ctx) { if (rf & 1) {
    const _r3 = i0.ɵɵgetCurrentView();
    i0.ɵɵelementStart(0, "ce-box-item", 1);
    i0.ɵɵlistener("ceOnStart", function CanvasComponent_ce_box_item_0_Template_ce_box_item_ceOnStart_0_listener($event) { i0.ɵɵrestoreView(_r3); const node_r1 = ctx.$implicit; const ctx_r2 = i0.ɵɵnextContext(); return ctx_r2.moveStart($event, node_r1); })("ceOnMove", function CanvasComponent_ce_box_item_0_Template_ce_box_item_ceOnMove_0_listener($event) { i0.ɵɵrestoreView(_r3); const ctx_r4 = i0.ɵɵnextContext(); return ctx_r4.moving($event); })("ceOnStop", function CanvasComponent_ce_box_item_0_Template_ce_box_item_ceOnStop_0_listener() { i0.ɵɵrestoreView(_r3); const ctx_r5 = i0.ɵɵnextContext(); return ctx_r5.moveEnd(); })("pointerenter", function CanvasComponent_ce_box_item_0_Template_ce_box_item_pointerenter_0_listener() { i0.ɵɵrestoreView(_r3); const node_r1 = ctx.$implicit; const ctx_r6 = i0.ɵɵnextContext(); return ctx_r6.showBorder(node_r1.id); })("pointerleave", function CanvasComponent_ce_box_item_0_Template_ce_box_item_pointerleave_0_listener() { i0.ɵɵrestoreView(_r3); const node_r1 = ctx.$implicit; const ctx_r7 = i0.ɵɵnextContext(); return ctx_r7.removeBorder(node_r1.id); });
    i0.ɵɵelementEnd();
} if (rf & 2) {
    const node_r1 = ctx.$implicit;
    i0.ɵɵproperty("ceDragDisabled", node_r1 == null ? null : node_r1.locked)("node", node_r1);
} }
const REF_LINE_DIRECTION_COMPARE_MAP = {
    tx: [
        {
            baseKey: 'top',
            referKey: 'top',
            baseValue: (baseRect, referRect) => ({ key: 'top', value: referRect.top }),
        },
        {
            baseKey: 'top',
            referKey: 'cy',
            baseValue: (baseRect, referRect) => ({ key: 'top', value: referRect.cy }),
        },
        {
            baseKey: 'top',
            referKey: 'bottom',
            baseValue: (baseRect, referRect) => ({ key: 'top', value: referRect.bottom }),
        },
    ],
    bx: [
        {
            baseKey: 'bottom',
            referKey: 'top',
            baseValue: (baseRect, referRect) => ({ key: 'top', value: referRect.top - baseRect.height }),
        },
        {
            baseKey: 'bottom',
            referKey: 'cy',
            baseValue: (baseRect, referRect) => ({ key: 'top', value: referRect.cy - baseRect.height }),
        },
        {
            baseKey: 'bottom',
            referKey: 'bottom',
            baseValue: (baseRect, referRect) => ({ key: 'top', value: referRect.bottom - baseRect.height }),
        },
    ],
    ly: [
        {
            baseKey: 'left',
            referKey: 'left',
            baseValue: (baseRect, referRect) => ({ key: 'left', value: referRect.left }),
        },
        {
            baseKey: 'left',
            referKey: 'cx',
            baseValue: (baseRect, referRect) => ({ key: 'left', value: referRect.cx }),
        },
        {
            baseKey: 'left',
            referKey: 'right',
            baseValue: (baseRect, referRect) => ({ key: 'left', value: referRect.right }),
        },
    ],
    ry: [
        {
            baseKey: 'right',
            referKey: 'left',
            baseValue: (baseRect, referRect) => ({ key: 'left', value: referRect.left - baseRect.width }),
        },
        {
            baseKey: 'right',
            referKey: 'cx',
            baseValue: (baseRect, referRect) => ({ key: 'left', value: referRect.cx - baseRect.width }),
        },
        {
            baseKey: 'right',
            referKey: 'right',
            baseValue: (baseRect, referRect) => ({ key: 'left', value: referRect.right - baseRect.width }),
        },
    ],
    cx: [
        {
            baseKey: 'cy',
            referKey: 'top',
            baseValue: (baseRect, referRect) => ({ key: 'top', value: referRect.top - baseRect.height / 2 }),
        },
        {
            baseKey: 'cy',
            referKey: 'cy',
            baseValue: (baseRect, referRect) => ({ key: 'top', value: referRect.cy - baseRect.height / 2 }),
        },
        {
            baseKey: 'cy',
            referKey: 'bottom',
            baseValue: (baseRect, referRect) => ({ key: 'top', value: referRect.bottom - baseRect.height / 2 }),
        },
    ],
    cy: [
        {
            baseKey: 'cx',
            referKey: 'left',
            baseValue: (baseRect, referRect) => ({ key: 'left', value: referRect.left - baseRect.width / 2 }),
        },
        {
            baseKey: 'cx',
            referKey: 'cx',
            baseValue: (baseRect, referRect) => ({ key: 'left', value: referRect.cx - baseRect.width / 2 }),
        },
        {
            baseKey: 'cx',
            referKey: 'right',
            baseValue: (baseRect, referRect) => ({ key: 'left', value: referRect.right - baseRect.width / 2 }),
        },
    ],
};
export class CanvasComponent {
    constructor(store, utils) {
        this.store = store;
        this.utils = utils;
        this.pointerSnapshot = null;
        this.nodesSnapshot = new Map();
        this.gap = 5;
        this.nodes$ = this.store.selectDifferent((state) => state.nodes);
        this.store.select((state) => state.nodes).subscribe((nodes) => (this.nodes = nodes));
        this.store.select((state) => state.selected).subscribe((state) => (this.selected = state));
        this.store.select((state) => state.canvasPosition).subscribe((state) => (this.canvasPosition = state));
    }
    nodeListTrackByFn(i, node) {
        return node.id;
    }
    moveStart(ev, node) {
        ev.preventDefault();
        ev.stopPropagation();
        this.nodesSnapshot.clear();
        this.pointerSnapshot = [ev.clientX, ev.clientY];
        let selected = [...this.selected];
        if (!this.selected.has(node.id)) {
            this.store.dispatch(clearBordered());
            this.store.dispatch(clearSelected());
            this.store.dispatch(addSelectedNodes([node.id]));
            selected = [node.id];
        }
        this.outerBoxSnapshot = this.utils.getOuterBoundingBox(selected
            .map((id) => this.utils.getNodeById(id, this.nodes))
            .map((item) => this.utils.getAbsolutePosition(item.left + item.width / 2, item.top + item.height / 2, item.width, item.height, item.rotate)));
        this.unselectedNodes = this.nodes.filter((item) => !selected.includes(item.id));
        selected.forEach((id) => {
            const item = this.nodes.find((n) => n.id === id);
            this.nodesSnapshot.set(item.id, Object.assign(Object.assign({}, item), { cxPercent: (item.left + item.width / 2 - this.outerBoxSnapshot.left) / this.outerBoxSnapshot.width, cyPercent: (item.top + item.height / 2 - this.outerBoxSnapshot.top) / this.outerBoxSnapshot.height }));
        });
    }
    moving(ev) {
        if (this.pointerSnapshot) {
            this.store.dispatch(resetRefLineState());
            const { scale } = this.canvasPosition;
            const [x, y] = this.pointerSnapshot;
            const [mx, my] = [(ev.clientX - x) / scale, (ev.clientY - y) / scale];
            const baseRect = Object.assign(Object.assign({}, this.outerBoxSnapshot), { left: this.outerBoxSnapshot.left + mx, top: this.outerBoxSnapshot.top + my, right: this.outerBoxSnapshot.right + mx, bottom: this.outerBoxSnapshot.bottom + my, cx: this.outerBoxSnapshot.cx + mx, cy: this.outerBoxSnapshot.cy + my });
            const refLinesState = {
                bx: null,
                tx: null,
                ly: null,
                ry: null,
                cx: null,
                cy: null,
            };
            this.unselectedNodes.forEach((node) => {
                const nodeRect = this.utils.getBoundingBox(node.width, node.height, node.left, node.top, node.rotate);
                ['tx', 'bx', 'ly', 'ry', 'cx', 'cy'].forEach((direction) => {
                    const result = getRefLineStateByDirection(direction, baseRect, nodeRect, this.gap / scale);
                    if (result) {
                        const { state, position, base } = result;
                        if (state) {
                            refLinesState[direction] = { state, position };
                            baseRect[base.key] = base.value;
                        }
                    }
                });
            });
            const newNodes = [];
            this.nodesSnapshot.forEach((node) => {
                const { cxPercent, cyPercent, width, height, nodeRect } = node, properties = __rest(node, ["cxPercent", "cyPercent", "width", "height", "nodeRect"]);
                newNodes.push(Object.assign(Object.assign({}, properties), { width,
                    height, left: cxPercent * baseRect.width + baseRect.left - width / 2, top: cyPercent * baseRect.height + baseRect.top - height / 2 }));
            });
            this.store.dispatch(updateRefLinesState(refLinesState));
            this.store.dispatch(updateNodes(newNodes));
        }
    }
    moveEnd() {
        this.pointerSnapshot = null;
        this.store.dispatch(resetRefLineState());
        this.nodesSnapshot.clear();
    }
    showBorder(id) {
        this.store.dispatch(addBorderedNodes([id]));
    }
    removeBorder(id) {
        if (!this.selected.has(id)) {
            this.store.dispatch(removeBorderedNodes([id]));
        }
    }
}
CanvasComponent.ɵfac = function CanvasComponent_Factory(t) { return new (t || CanvasComponent)(i0.ɵɵdirectiveInject(i1.EditorStore), i0.ɵɵdirectiveInject(i2.CeUtilsService)); };
CanvasComponent.ɵcmp = i0.ɵɵdefineComponent({ type: CanvasComponent, selectors: [["ce-canvas"]], decls: 2, vars: 4, consts: [["ceDraggable", "", 3, "ceDragDisabled", "node", "ceOnStart", "ceOnMove", "ceOnStop", "pointerenter", "pointerleave", 4, "ngFor", "ngForOf", "ngForTrackBy"], ["ceDraggable", "", 3, "ceDragDisabled", "node", "ceOnStart", "ceOnMove", "ceOnStop", "pointerenter", "pointerleave"]], template: function CanvasComponent_Template(rf, ctx) { if (rf & 1) {
        i0.ɵɵtemplate(0, CanvasComponent_ce_box_item_0_Template, 1, 2, "ce-box-item", 0);
        i0.ɵɵpipe(1, "async");
    } if (rf & 2) {
        i0.ɵɵproperty("ngForOf", i0.ɵɵpipeBind1(1, 2, ctx.nodes$))("ngForTrackBy", ctx.nodeListTrackByFn);
    } }, directives: [i3.NgForOf, i4.BoxItemComponent, i5.DraggableDirective], pipes: [i3.AsyncPipe], styles: ["ce-canvas{bottom:0;left:0;position:absolute;right:0;top:0}"], encapsulation: 2, changeDetection: 0 });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(CanvasComponent, [{
        type: Component,
        args: [{
                selector: 'ce-canvas',
                templateUrl: 'canvas.component.html',
                styleUrls: ['canvas.component.less'],
                encapsulation: ViewEncapsulation.None,
                changeDetection: ChangeDetectionStrategy.OnPush,
            }]
    }], function () { return [{ type: i1.EditorStore }, { type: i2.CeUtilsService }]; }, null); })();
function getRefLineStateByDirection(direction, baseRect, referRect, gap) {
    return REF_LINE_DIRECTION_COMPARE_MAP[direction]
        .map(({ baseKey, referKey, baseValue }) => ({
        state: Math.abs(baseRect[baseKey] - referRect[referKey]) < gap,
        position: referRect[referKey],
        base: baseValue(baseRect, referRect),
    }))
        .find((item) => item.state);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FudmFzLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyLWVkaXRvci1saWIvc3JjLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvY2FudmFzL2NhbnZhcy5jb21wb25lbnQudHMiLCJsaWIvY29tcG9uZW50cy9jYW52YXMvY2FudmFzLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsU0FBUyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXRGLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsZ0JBQWdCLEVBQ2hCLGFBQWEsRUFDYixhQUFhLEVBQ2IsbUJBQW1CLEVBQ25CLGlCQUFpQixFQUNqQixXQUFXLEVBQ1gsbUJBQW1CLEdBQ3BCLE1BQU0sZUFBZSxDQUFDOzs7Ozs7Ozs7SUNYdkIsc0NBVUM7SUFOQywyUEFBcUMsaU1BQUEsc0xBQUEsME9BQUEsNE9BQUE7SUFNdEMsaUJBQWM7OztJQVBiLHdFQUErQixpQkFBQTs7QURhakMsTUFBTSw4QkFBOEIsR0FNaEM7SUFDRixFQUFFLEVBQUU7UUFDRjtZQUNFLE9BQU8sRUFBRSxLQUFLO1lBQ2QsUUFBUSxFQUFFLEtBQUs7WUFDZixTQUFTLEVBQUUsQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDO1NBQzNFO1FBQ0Q7WUFDRSxPQUFPLEVBQUUsS0FBSztZQUNkLFFBQVEsRUFBRSxJQUFJO1lBQ2QsU0FBUyxFQUFFLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLFNBQVMsQ0FBQyxFQUFFLEVBQUUsQ0FBQztTQUMxRTtRQUNEO1lBQ0UsT0FBTyxFQUFFLEtBQUs7WUFDZCxRQUFRLEVBQUUsUUFBUTtZQUNsQixTQUFTLEVBQUUsQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQzlFO0tBQ0Y7SUFDRCxFQUFFLEVBQUU7UUFDRjtZQUNFLE9BQU8sRUFBRSxRQUFRO1lBQ2pCLFFBQVEsRUFBRSxLQUFLO1lBQ2YsU0FBUyxFQUFFLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLFNBQVMsQ0FBQyxHQUFHLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQzdGO1FBQ0Q7WUFDRSxPQUFPLEVBQUUsUUFBUTtZQUNqQixRQUFRLEVBQUUsSUFBSTtZQUNkLFNBQVMsRUFBRSxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxTQUFTLENBQUMsRUFBRSxHQUFHLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUM1RjtRQUNEO1lBQ0UsT0FBTyxFQUFFLFFBQVE7WUFDakIsUUFBUSxFQUFFLFFBQVE7WUFDbEIsU0FBUyxFQUFFLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLFNBQVMsQ0FBQyxNQUFNLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQ2hHO0tBQ0Y7SUFDRCxFQUFFLEVBQUU7UUFDRjtZQUNFLE9BQU8sRUFBRSxNQUFNO1lBQ2YsUUFBUSxFQUFFLE1BQU07WUFDaEIsU0FBUyxFQUFFLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUM3RTtRQUNEO1lBQ0UsT0FBTyxFQUFFLE1BQU07WUFDZixRQUFRLEVBQUUsSUFBSTtZQUNkLFNBQVMsRUFBRSxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxTQUFTLENBQUMsRUFBRSxFQUFFLENBQUM7U0FDM0U7UUFDRDtZQUNFLE9BQU8sRUFBRSxNQUFNO1lBQ2YsUUFBUSxFQUFFLE9BQU87WUFDakIsU0FBUyxFQUFFLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUM5RTtLQUNGO0lBQ0QsRUFBRSxFQUFFO1FBQ0Y7WUFDRSxPQUFPLEVBQUUsT0FBTztZQUNoQixRQUFRLEVBQUUsTUFBTTtZQUNoQixTQUFTLEVBQUUsQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsU0FBUyxDQUFDLElBQUksR0FBRyxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDOUY7UUFDRDtZQUNFLE9BQU8sRUFBRSxPQUFPO1lBQ2hCLFFBQVEsRUFBRSxJQUFJO1lBQ2QsU0FBUyxFQUFFLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLFNBQVMsQ0FBQyxFQUFFLEdBQUcsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQzVGO1FBQ0Q7WUFDRSxPQUFPLEVBQUUsT0FBTztZQUNoQixRQUFRLEVBQUUsT0FBTztZQUNqQixTQUFTLEVBQUUsQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsU0FBUyxDQUFDLEtBQUssR0FBRyxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDL0Y7S0FDRjtJQUNELEVBQUUsRUFBRTtRQUNGO1lBQ0UsT0FBTyxFQUFFLElBQUk7WUFDYixRQUFRLEVBQUUsS0FBSztZQUNmLFNBQVMsRUFBRSxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxTQUFTLENBQUMsR0FBRyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7U0FDakc7UUFDRDtZQUNFLE9BQU8sRUFBRSxJQUFJO1lBQ2IsUUFBUSxFQUFFLElBQUk7WUFDZCxTQUFTLEVBQUUsQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsU0FBUyxDQUFDLEVBQUUsR0FBRyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1NBQ2hHO1FBQ0Q7WUFDRSxPQUFPLEVBQUUsSUFBSTtZQUNiLFFBQVEsRUFBRSxRQUFRO1lBQ2xCLFNBQVMsRUFBRSxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxTQUFTLENBQUMsTUFBTSxHQUFHLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7U0FDcEc7S0FDRjtJQUNELEVBQUUsRUFBRTtRQUNGO1lBQ0UsT0FBTyxFQUFFLElBQUk7WUFDYixRQUFRLEVBQUUsTUFBTTtZQUNoQixTQUFTLEVBQUUsQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsU0FBUyxDQUFDLElBQUksR0FBRyxRQUFRLENBQUMsS0FBSyxHQUFHLENBQUMsRUFBRSxDQUFDO1NBQ2xHO1FBQ0Q7WUFDRSxPQUFPLEVBQUUsSUFBSTtZQUNiLFFBQVEsRUFBRSxJQUFJO1lBQ2QsU0FBUyxFQUFFLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLFNBQVMsQ0FBQyxFQUFFLEdBQUcsUUFBUSxDQUFDLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQztTQUNoRztRQUNEO1lBQ0UsT0FBTyxFQUFFLElBQUk7WUFDYixRQUFRLEVBQUUsT0FBTztZQUNqQixTQUFTLEVBQUUsQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsU0FBUyxDQUFDLEtBQUssR0FBRyxRQUFRLENBQUMsS0FBSyxHQUFHLENBQUMsRUFBRSxDQUFDO1NBQ25HO0tBQ0Y7Q0FDRixDQUFDO0FBUUYsTUFBTSxPQUFPLGVBQWU7SUFXMUIsWUFBb0IsS0FBMEIsRUFBVSxLQUFxQjtRQUF6RCxVQUFLLEdBQUwsS0FBSyxDQUFxQjtRQUFVLFVBQUssR0FBTCxLQUFLLENBQWdCO1FBTnJFLG9CQUFlLEdBQXFCLElBQUksQ0FBQztRQUN6QyxrQkFBYSxHQUF1QixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRzlDLFFBQUcsR0FBRyxDQUFDLENBQUM7UUFHZCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDakUsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ3JGLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUMzRixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDekcsQ0FBQztJQUVELGlCQUFpQixDQUFDLENBQVMsRUFBRSxJQUFXO1FBQ3RDLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQztJQUNqQixDQUFDO0lBRUQsU0FBUyxDQUFDLEVBQWdCLEVBQUUsSUFBVztRQUNyQyxFQUFFLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDcEIsRUFBRSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLGVBQWUsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2hELElBQUksUUFBUSxHQUFhLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRTtZQUMvQixJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDO1lBQ3JDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUM7WUFDckMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pELFFBQVEsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUN0QjtRQUVELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUNwRCxRQUFRO2FBQ0wsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ25ELEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUMvSSxDQUFDO1FBQ0YsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRWhGLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRTtZQUN0QixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUNqRCxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxrQ0FDekIsSUFBSSxLQUNQLFNBQVMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQ2xHLFNBQVMsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLElBQ2xHLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxNQUFNLENBQUMsRUFBZ0I7UUFDckIsSUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFO1lBQ3hCLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLGlCQUFpQixFQUFFLENBQUMsQ0FBQztZQUN6QyxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQztZQUN0QyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUM7WUFDcEMsTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsR0FBRyxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDO1lBQ3RFLE1BQU0sUUFBUSxtQ0FDVCxJQUFJLENBQUMsZ0JBQWdCLEtBQ3hCLElBQUksRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxHQUFHLEVBQUUsRUFDckMsR0FBRyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEdBQUcsRUFBRSxFQUNuQyxLQUFLLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssR0FBRyxFQUFFLEVBQ3ZDLE1BQU0sRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxHQUFHLEVBQUUsRUFDekMsRUFBRSxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLEdBQUcsRUFBRSxFQUNqQyxFQUFFLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQ2xDLENBQUM7WUFDRixNQUFNLGFBQWEsR0FBZ0Q7Z0JBQ2pFLEVBQUUsRUFBRSxJQUFJO2dCQUNSLEVBQUUsRUFBRSxJQUFJO2dCQUNSLEVBQUUsRUFBRSxJQUFJO2dCQUNSLEVBQUUsRUFBRSxJQUFJO2dCQUNSLEVBQUUsRUFBRSxJQUFJO2dCQUNSLEVBQUUsRUFBRSxJQUFJO2FBQ1QsQ0FBQztZQUNGLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7Z0JBQ3BDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUN0RyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsU0FBNEIsRUFBRSxFQUFFO29CQUM1RSxNQUFNLE1BQU0sR0FBRywwQkFBMEIsQ0FBQyxTQUFTLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsR0FBRyxHQUFHLEtBQUssQ0FBQyxDQUFDO29CQUMzRixJQUFJLE1BQU0sRUFBRTt3QkFDVixNQUFNLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsR0FBRyxNQUFNLENBQUM7d0JBQ3pDLElBQUksS0FBSyxFQUFFOzRCQUNULGFBQWEsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsQ0FBQzs0QkFDL0MsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO3lCQUNqQztxQkFDRjtnQkFDSCxDQUFDLENBQUMsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxRQUFRLEdBQVksRUFBRSxDQUFDO1lBQzdCLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7Z0JBQ2xDLE1BQU0sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsUUFBUSxLQUFvQixJQUFJLEVBQW5CLFVBQVUsVUFBSyxJQUFJLEVBQXZFLHlEQUFnRSxDQUFPLENBQUM7Z0JBQzlFLFFBQVEsQ0FBQyxJQUFJLGlDQUNSLFVBQVUsS0FDYixLQUFLO29CQUNMLE1BQU0sRUFDTixJQUFJLEVBQUUsU0FBUyxHQUFHLFFBQVEsQ0FBQyxLQUFLLEdBQUcsUUFBUSxDQUFDLElBQUksR0FBRyxLQUFLLEdBQUcsQ0FBQyxFQUM1RCxHQUFHLEVBQUUsU0FBUyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEdBQUcsUUFBUSxDQUFDLEdBQUcsR0FBRyxNQUFNLEdBQUcsQ0FBQyxJQUM1RCxDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7WUFFSCxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1lBQ3hELElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1NBQzVDO0lBQ0gsQ0FBQztJQUVELE9BQU87UUFDTCxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQztRQUM1QixJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUM3QixDQUFDO0lBRUQsVUFBVSxDQUFDLEVBQVU7UUFDbkIsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUVELFlBQVksQ0FBQyxFQUFVO1FBQ3JCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRTtZQUMxQixJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNoRDtJQUNILENBQUM7OzhFQXZIVSxlQUFlO29EQUFmLGVBQWU7UUNySTVCLGdGQVVlOzs7UUFUSSwwREFBbUIsdUNBQUE7O2tERG9JekIsZUFBZTtjQVAzQixTQUFTO2VBQUM7Z0JBQ1QsUUFBUSxFQUFFLFdBQVc7Z0JBQ3JCLFdBQVcsRUFBRSx1QkFBdUI7Z0JBQ3BDLFNBQVMsRUFBRSxDQUFDLHVCQUF1QixDQUFDO2dCQUNwQyxhQUFhLEVBQUUsaUJBQWlCLENBQUMsSUFBSTtnQkFDckMsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07YUFDaEQ7O0FBMkhELFNBQVMsMEJBQTBCLENBQ2pDLFNBQTRCLEVBQzVCLFFBQWtCLEVBQ2xCLFNBQW1CLEVBQ25CLEdBQVc7SUFFWCxPQUFPLDhCQUE4QixDQUFDLFNBQVMsQ0FBQztTQUM3QyxHQUFHLENBQUMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDMUMsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLEdBQUc7UUFDOUQsUUFBUSxFQUFFLFNBQVMsQ0FBQyxRQUFRLENBQUM7UUFDN0IsSUFBSSxFQUFFLFNBQVMsQ0FBQyxRQUFRLEVBQUUsU0FBUyxDQUFDO0tBQ3JDLENBQUMsQ0FBQztTQUNGLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ2hDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgQ29tcG9uZW50LCBWaWV3RW5jYXBzdWxhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgYWRkQm9yZGVyZWROb2RlcyxcbiAgYWRkU2VsZWN0ZWROb2RlcyxcbiAgY2xlYXJCb3JkZXJlZCxcbiAgY2xlYXJTZWxlY3RlZCxcbiAgcmVtb3ZlQm9yZGVyZWROb2RlcyxcbiAgcmVzZXRSZWZMaW5lU3RhdGUsXG4gIHVwZGF0ZU5vZGVzLFxuICB1cGRhdGVSZWZMaW5lc1N0YXRlLFxufSBmcm9tICcuLi8uLi9hY3Rpb25zJztcbmltcG9ydCB7IEVkaXRvclN0b3JlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMnO1xuaW1wb3J0IHsgQ2VVdGlsc1NlcnZpY2UsIElET01SZWN0IH0gZnJvbSAnLi4vLi4vc2VydmljZXMvdXRpbHMuc2VydmljZSc7XG5pbXBvcnQgeyBJQ2FudmFzUG9zaXRpb24sIElOb2RlLCBJUmVmTGluZURpcmVjdGlvbiwgSVJlZkxpbmVTdGF0ZSwgSVN0b3JlIH0gZnJvbSAnLi4vLi4vc3RvcmUnO1xuXG5jb25zdCBSRUZfTElORV9ESVJFQ1RJT05fQ09NUEFSRV9NQVA6IHtcbiAgW1AgaW4gSVJlZkxpbmVEaXJlY3Rpb25dOiB7XG4gICAgYmFzZUtleToga2V5b2YgSURPTVJlY3Q7XG4gICAgcmVmZXJLZXk6IGtleW9mIElET01SZWN0O1xuICAgIGJhc2VWYWx1ZTogKGJhc2VSZWN0OiBJRE9NUmVjdCwgcmVmZXJSZWN0OiBJRE9NUmVjdCkgPT4geyBrZXk6IGtleW9mIElET01SZWN0OyB2YWx1ZTogbnVtYmVyIH07XG4gIH1bXTtcbn0gPSB7XG4gIHR4OiBbXG4gICAge1xuICAgICAgYmFzZUtleTogJ3RvcCcsXG4gICAgICByZWZlcktleTogJ3RvcCcsXG4gICAgICBiYXNlVmFsdWU6IChiYXNlUmVjdCwgcmVmZXJSZWN0KSA9PiAoeyBrZXk6ICd0b3AnLCB2YWx1ZTogcmVmZXJSZWN0LnRvcCB9KSxcbiAgICB9LFxuICAgIHtcbiAgICAgIGJhc2VLZXk6ICd0b3AnLFxuICAgICAgcmVmZXJLZXk6ICdjeScsXG4gICAgICBiYXNlVmFsdWU6IChiYXNlUmVjdCwgcmVmZXJSZWN0KSA9PiAoeyBrZXk6ICd0b3AnLCB2YWx1ZTogcmVmZXJSZWN0LmN5IH0pLFxuICAgIH0sXG4gICAge1xuICAgICAgYmFzZUtleTogJ3RvcCcsXG4gICAgICByZWZlcktleTogJ2JvdHRvbScsXG4gICAgICBiYXNlVmFsdWU6IChiYXNlUmVjdCwgcmVmZXJSZWN0KSA9PiAoeyBrZXk6ICd0b3AnLCB2YWx1ZTogcmVmZXJSZWN0LmJvdHRvbSB9KSxcbiAgICB9LFxuICBdLFxuICBieDogW1xuICAgIHtcbiAgICAgIGJhc2VLZXk6ICdib3R0b20nLFxuICAgICAgcmVmZXJLZXk6ICd0b3AnLFxuICAgICAgYmFzZVZhbHVlOiAoYmFzZVJlY3QsIHJlZmVyUmVjdCkgPT4gKHsga2V5OiAndG9wJywgdmFsdWU6IHJlZmVyUmVjdC50b3AgLSBiYXNlUmVjdC5oZWlnaHQgfSksXG4gICAgfSxcbiAgICB7XG4gICAgICBiYXNlS2V5OiAnYm90dG9tJyxcbiAgICAgIHJlZmVyS2V5OiAnY3knLFxuICAgICAgYmFzZVZhbHVlOiAoYmFzZVJlY3QsIHJlZmVyUmVjdCkgPT4gKHsga2V5OiAndG9wJywgdmFsdWU6IHJlZmVyUmVjdC5jeSAtIGJhc2VSZWN0LmhlaWdodCB9KSxcbiAgICB9LFxuICAgIHtcbiAgICAgIGJhc2VLZXk6ICdib3R0b20nLFxuICAgICAgcmVmZXJLZXk6ICdib3R0b20nLFxuICAgICAgYmFzZVZhbHVlOiAoYmFzZVJlY3QsIHJlZmVyUmVjdCkgPT4gKHsga2V5OiAndG9wJywgdmFsdWU6IHJlZmVyUmVjdC5ib3R0b20gLSBiYXNlUmVjdC5oZWlnaHQgfSksXG4gICAgfSxcbiAgXSxcbiAgbHk6IFtcbiAgICB7XG4gICAgICBiYXNlS2V5OiAnbGVmdCcsXG4gICAgICByZWZlcktleTogJ2xlZnQnLFxuICAgICAgYmFzZVZhbHVlOiAoYmFzZVJlY3QsIHJlZmVyUmVjdCkgPT4gKHsga2V5OiAnbGVmdCcsIHZhbHVlOiByZWZlclJlY3QubGVmdCB9KSxcbiAgICB9LFxuICAgIHtcbiAgICAgIGJhc2VLZXk6ICdsZWZ0JyxcbiAgICAgIHJlZmVyS2V5OiAnY3gnLFxuICAgICAgYmFzZVZhbHVlOiAoYmFzZVJlY3QsIHJlZmVyUmVjdCkgPT4gKHsga2V5OiAnbGVmdCcsIHZhbHVlOiByZWZlclJlY3QuY3ggfSksXG4gICAgfSxcbiAgICB7XG4gICAgICBiYXNlS2V5OiAnbGVmdCcsXG4gICAgICByZWZlcktleTogJ3JpZ2h0JyxcbiAgICAgIGJhc2VWYWx1ZTogKGJhc2VSZWN0LCByZWZlclJlY3QpID0+ICh7IGtleTogJ2xlZnQnLCB2YWx1ZTogcmVmZXJSZWN0LnJpZ2h0IH0pLFxuICAgIH0sXG4gIF0sXG4gIHJ5OiBbXG4gICAge1xuICAgICAgYmFzZUtleTogJ3JpZ2h0JyxcbiAgICAgIHJlZmVyS2V5OiAnbGVmdCcsXG4gICAgICBiYXNlVmFsdWU6IChiYXNlUmVjdCwgcmVmZXJSZWN0KSA9PiAoeyBrZXk6ICdsZWZ0JywgdmFsdWU6IHJlZmVyUmVjdC5sZWZ0IC0gYmFzZVJlY3Qud2lkdGggfSksXG4gICAgfSxcbiAgICB7XG4gICAgICBiYXNlS2V5OiAncmlnaHQnLFxuICAgICAgcmVmZXJLZXk6ICdjeCcsXG4gICAgICBiYXNlVmFsdWU6IChiYXNlUmVjdCwgcmVmZXJSZWN0KSA9PiAoeyBrZXk6ICdsZWZ0JywgdmFsdWU6IHJlZmVyUmVjdC5jeCAtIGJhc2VSZWN0LndpZHRoIH0pLFxuICAgIH0sXG4gICAge1xuICAgICAgYmFzZUtleTogJ3JpZ2h0JyxcbiAgICAgIHJlZmVyS2V5OiAncmlnaHQnLFxuICAgICAgYmFzZVZhbHVlOiAoYmFzZVJlY3QsIHJlZmVyUmVjdCkgPT4gKHsga2V5OiAnbGVmdCcsIHZhbHVlOiByZWZlclJlY3QucmlnaHQgLSBiYXNlUmVjdC53aWR0aCB9KSxcbiAgICB9LFxuICBdLFxuICBjeDogW1xuICAgIHtcbiAgICAgIGJhc2VLZXk6ICdjeScsXG4gICAgICByZWZlcktleTogJ3RvcCcsXG4gICAgICBiYXNlVmFsdWU6IChiYXNlUmVjdCwgcmVmZXJSZWN0KSA9PiAoeyBrZXk6ICd0b3AnLCB2YWx1ZTogcmVmZXJSZWN0LnRvcCAtIGJhc2VSZWN0LmhlaWdodCAvIDIgfSksXG4gICAgfSxcbiAgICB7XG4gICAgICBiYXNlS2V5OiAnY3knLFxuICAgICAgcmVmZXJLZXk6ICdjeScsXG4gICAgICBiYXNlVmFsdWU6IChiYXNlUmVjdCwgcmVmZXJSZWN0KSA9PiAoeyBrZXk6ICd0b3AnLCB2YWx1ZTogcmVmZXJSZWN0LmN5IC0gYmFzZVJlY3QuaGVpZ2h0IC8gMiB9KSxcbiAgICB9LFxuICAgIHtcbiAgICAgIGJhc2VLZXk6ICdjeScsXG4gICAgICByZWZlcktleTogJ2JvdHRvbScsXG4gICAgICBiYXNlVmFsdWU6IChiYXNlUmVjdCwgcmVmZXJSZWN0KSA9PiAoeyBrZXk6ICd0b3AnLCB2YWx1ZTogcmVmZXJSZWN0LmJvdHRvbSAtIGJhc2VSZWN0LmhlaWdodCAvIDIgfSksXG4gICAgfSxcbiAgXSxcbiAgY3k6IFtcbiAgICB7XG4gICAgICBiYXNlS2V5OiAnY3gnLFxuICAgICAgcmVmZXJLZXk6ICdsZWZ0JyxcbiAgICAgIGJhc2VWYWx1ZTogKGJhc2VSZWN0LCByZWZlclJlY3QpID0+ICh7IGtleTogJ2xlZnQnLCB2YWx1ZTogcmVmZXJSZWN0LmxlZnQgLSBiYXNlUmVjdC53aWR0aCAvIDIgfSksXG4gICAgfSxcbiAgICB7XG4gICAgICBiYXNlS2V5OiAnY3gnLFxuICAgICAgcmVmZXJLZXk6ICdjeCcsXG4gICAgICBiYXNlVmFsdWU6IChiYXNlUmVjdCwgcmVmZXJSZWN0KSA9PiAoeyBrZXk6ICdsZWZ0JywgdmFsdWU6IHJlZmVyUmVjdC5jeCAtIGJhc2VSZWN0LndpZHRoIC8gMiB9KSxcbiAgICB9LFxuICAgIHtcbiAgICAgIGJhc2VLZXk6ICdjeCcsXG4gICAgICByZWZlcktleTogJ3JpZ2h0JyxcbiAgICAgIGJhc2VWYWx1ZTogKGJhc2VSZWN0LCByZWZlclJlY3QpID0+ICh7IGtleTogJ2xlZnQnLCB2YWx1ZTogcmVmZXJSZWN0LnJpZ2h0IC0gYmFzZVJlY3Qud2lkdGggLyAyIH0pLFxuICAgIH0sXG4gIF0sXG59O1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnY2UtY2FudmFzJyxcbiAgdGVtcGxhdGVVcmw6ICdjYW52YXMuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnY2FudmFzLmNvbXBvbmVudC5sZXNzJ10sXG4gIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmUsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBDYW52YXNDb21wb25lbnQge1xuICBwdWJsaWMgbm9kZXMkOiBPYnNlcnZhYmxlPElOb2RlW10+O1xuICBwdWJsaWMgbm9kZXM6IElOb2RlW107XG4gIHByaXZhdGUgc2VsZWN0ZWQ6IFNldDxzdHJpbmc+O1xuICBwcml2YXRlIGNhbnZhc1Bvc2l0aW9uOiBJQ2FudmFzUG9zaXRpb247XG4gIHByaXZhdGUgcG9pbnRlclNuYXBzaG90OiBbbnVtYmVyLCBudW1iZXJdID0gbnVsbDtcbiAgcHJpdmF0ZSBub2Rlc1NuYXBzaG90OiBNYXA8c3RyaW5nLCBJTm9kZT4gPSBuZXcgTWFwKCk7XG4gIHByaXZhdGUgb3V0ZXJCb3hTbmFwc2hvdDogSURPTVJlY3Q7XG4gIHByaXZhdGUgdW5zZWxlY3RlZE5vZGVzOiBJTm9kZVtdO1xuICBwcml2YXRlIGdhcCA9IDU7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBzdG9yZTogRWRpdG9yU3RvcmU8SVN0b3JlPiwgcHJpdmF0ZSB1dGlsczogQ2VVdGlsc1NlcnZpY2UpIHtcbiAgICB0aGlzLm5vZGVzJCA9IHRoaXMuc3RvcmUuc2VsZWN0RGlmZmVyZW50KChzdGF0ZSkgPT4gc3RhdGUubm9kZXMpO1xuICAgIHRoaXMuc3RvcmUuc2VsZWN0KChzdGF0ZSkgPT4gc3RhdGUubm9kZXMpLnN1YnNjcmliZSgobm9kZXMpID0+ICh0aGlzLm5vZGVzID0gbm9kZXMpKTtcbiAgICB0aGlzLnN0b3JlLnNlbGVjdCgoc3RhdGUpID0+IHN0YXRlLnNlbGVjdGVkKS5zdWJzY3JpYmUoKHN0YXRlKSA9PiAodGhpcy5zZWxlY3RlZCA9IHN0YXRlKSk7XG4gICAgdGhpcy5zdG9yZS5zZWxlY3QoKHN0YXRlKSA9PiBzdGF0ZS5jYW52YXNQb3NpdGlvbikuc3Vic2NyaWJlKChzdGF0ZSkgPT4gKHRoaXMuY2FudmFzUG9zaXRpb24gPSBzdGF0ZSkpO1xuICB9XG5cbiAgbm9kZUxpc3RUcmFja0J5Rm4oaTogbnVtYmVyLCBub2RlOiBJTm9kZSk6IHN0cmluZyB7XG4gICAgcmV0dXJuIG5vZGUuaWQ7XG4gIH1cblxuICBtb3ZlU3RhcnQoZXY6IFBvaW50ZXJFdmVudCwgbm9kZTogSU5vZGUpOiB2b2lkIHtcbiAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMubm9kZXNTbmFwc2hvdC5jbGVhcigpO1xuICAgIHRoaXMucG9pbnRlclNuYXBzaG90ID0gW2V2LmNsaWVudFgsIGV2LmNsaWVudFldO1xuICAgIGxldCBzZWxlY3RlZDogc3RyaW5nW10gPSBbLi4udGhpcy5zZWxlY3RlZF07XG4gICAgaWYgKCF0aGlzLnNlbGVjdGVkLmhhcyhub2RlLmlkKSkge1xuICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChjbGVhckJvcmRlcmVkKCkpO1xuICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChjbGVhclNlbGVjdGVkKCkpO1xuICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChhZGRTZWxlY3RlZE5vZGVzKFtub2RlLmlkXSkpO1xuICAgICAgc2VsZWN0ZWQgPSBbbm9kZS5pZF07XG4gICAgfVxuXG4gICAgdGhpcy5vdXRlckJveFNuYXBzaG90ID0gdGhpcy51dGlscy5nZXRPdXRlckJvdW5kaW5nQm94KFxuICAgICAgc2VsZWN0ZWRcbiAgICAgICAgLm1hcCgoaWQpID0+IHRoaXMudXRpbHMuZ2V0Tm9kZUJ5SWQoaWQsIHRoaXMubm9kZXMpKVxuICAgICAgICAubWFwKChpdGVtKSA9PiB0aGlzLnV0aWxzLmdldEFic29sdXRlUG9zaXRpb24oaXRlbS5sZWZ0ICsgaXRlbS53aWR0aCAvIDIsIGl0ZW0udG9wICsgaXRlbS5oZWlnaHQgLyAyLCBpdGVtLndpZHRoLCBpdGVtLmhlaWdodCwgaXRlbS5yb3RhdGUpKVxuICAgICk7XG4gICAgdGhpcy51bnNlbGVjdGVkTm9kZXMgPSB0aGlzLm5vZGVzLmZpbHRlcigoaXRlbSkgPT4gIXNlbGVjdGVkLmluY2x1ZGVzKGl0ZW0uaWQpKTtcblxuICAgIHNlbGVjdGVkLmZvckVhY2goKGlkKSA9PiB7XG4gICAgICBjb25zdCBpdGVtID0gdGhpcy5ub2Rlcy5maW5kKChuKSA9PiBuLmlkID09PSBpZCk7XG4gICAgICB0aGlzLm5vZGVzU25hcHNob3Quc2V0KGl0ZW0uaWQsIHtcbiAgICAgICAgLi4uaXRlbSxcbiAgICAgICAgY3hQZXJjZW50OiAoaXRlbS5sZWZ0ICsgaXRlbS53aWR0aCAvIDIgLSB0aGlzLm91dGVyQm94U25hcHNob3QubGVmdCkgLyB0aGlzLm91dGVyQm94U25hcHNob3Qud2lkdGgsXG4gICAgICAgIGN5UGVyY2VudDogKGl0ZW0udG9wICsgaXRlbS5oZWlnaHQgLyAyIC0gdGhpcy5vdXRlckJveFNuYXBzaG90LnRvcCkgLyB0aGlzLm91dGVyQm94U25hcHNob3QuaGVpZ2h0LFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBtb3ZpbmcoZXY6IFBvaW50ZXJFdmVudCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnBvaW50ZXJTbmFwc2hvdCkge1xuICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChyZXNldFJlZkxpbmVTdGF0ZSgpKTtcbiAgICAgIGNvbnN0IHsgc2NhbGUgfSA9IHRoaXMuY2FudmFzUG9zaXRpb247XG4gICAgICBjb25zdCBbeCwgeV0gPSB0aGlzLnBvaW50ZXJTbmFwc2hvdDtcbiAgICAgIGNvbnN0IFtteCwgbXldID0gWyhldi5jbGllbnRYIC0geCkgLyBzY2FsZSwgKGV2LmNsaWVudFkgLSB5KSAvIHNjYWxlXTtcbiAgICAgIGNvbnN0IGJhc2VSZWN0OiBJRE9NUmVjdCA9IHtcbiAgICAgICAgLi4udGhpcy5vdXRlckJveFNuYXBzaG90LFxuICAgICAgICBsZWZ0OiB0aGlzLm91dGVyQm94U25hcHNob3QubGVmdCArIG14LFxuICAgICAgICB0b3A6IHRoaXMub3V0ZXJCb3hTbmFwc2hvdC50b3AgKyBteSxcbiAgICAgICAgcmlnaHQ6IHRoaXMub3V0ZXJCb3hTbmFwc2hvdC5yaWdodCArIG14LFxuICAgICAgICBib3R0b206IHRoaXMub3V0ZXJCb3hTbmFwc2hvdC5ib3R0b20gKyBteSxcbiAgICAgICAgY3g6IHRoaXMub3V0ZXJCb3hTbmFwc2hvdC5jeCArIG14LFxuICAgICAgICBjeTogdGhpcy5vdXRlckJveFNuYXBzaG90LmN5ICsgbXksXG4gICAgICB9O1xuICAgICAgY29uc3QgcmVmTGluZXNTdGF0ZTogeyBbUCBpbiBJUmVmTGluZURpcmVjdGlvbl06IElSZWZMaW5lU3RhdGUgfSA9IHtcbiAgICAgICAgYng6IG51bGwsXG4gICAgICAgIHR4OiBudWxsLFxuICAgICAgICBseTogbnVsbCxcbiAgICAgICAgcnk6IG51bGwsXG4gICAgICAgIGN4OiBudWxsLFxuICAgICAgICBjeTogbnVsbCxcbiAgICAgIH07XG4gICAgICB0aGlzLnVuc2VsZWN0ZWROb2Rlcy5mb3JFYWNoKChub2RlKSA9PiB7XG4gICAgICAgIGNvbnN0IG5vZGVSZWN0ID0gdGhpcy51dGlscy5nZXRCb3VuZGluZ0JveChub2RlLndpZHRoLCBub2RlLmhlaWdodCwgbm9kZS5sZWZ0LCBub2RlLnRvcCwgbm9kZS5yb3RhdGUpO1xuICAgICAgICBbJ3R4JywgJ2J4JywgJ2x5JywgJ3J5JywgJ2N4JywgJ2N5J10uZm9yRWFjaCgoZGlyZWN0aW9uOiBJUmVmTGluZURpcmVjdGlvbikgPT4ge1xuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGdldFJlZkxpbmVTdGF0ZUJ5RGlyZWN0aW9uKGRpcmVjdGlvbiwgYmFzZVJlY3QsIG5vZGVSZWN0LCB0aGlzLmdhcCAvIHNjYWxlKTtcbiAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICBjb25zdCB7IHN0YXRlLCBwb3NpdGlvbiwgYmFzZSB9ID0gcmVzdWx0O1xuICAgICAgICAgICAgaWYgKHN0YXRlKSB7XG4gICAgICAgICAgICAgIHJlZkxpbmVzU3RhdGVbZGlyZWN0aW9uXSA9IHsgc3RhdGUsIHBvc2l0aW9uIH07XG4gICAgICAgICAgICAgIGJhc2VSZWN0W2Jhc2Uua2V5XSA9IGJhc2UudmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgICAgY29uc3QgbmV3Tm9kZXM6IElOb2RlW10gPSBbXTtcbiAgICAgIHRoaXMubm9kZXNTbmFwc2hvdC5mb3JFYWNoKChub2RlKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgY3hQZXJjZW50LCBjeVBlcmNlbnQsIHdpZHRoLCBoZWlnaHQsIG5vZGVSZWN0LCAuLi5wcm9wZXJ0aWVzIH0gPSBub2RlO1xuICAgICAgICBuZXdOb2Rlcy5wdXNoKHtcbiAgICAgICAgICAuLi5wcm9wZXJ0aWVzLFxuICAgICAgICAgIHdpZHRoLFxuICAgICAgICAgIGhlaWdodCxcbiAgICAgICAgICBsZWZ0OiBjeFBlcmNlbnQgKiBiYXNlUmVjdC53aWR0aCArIGJhc2VSZWN0LmxlZnQgLSB3aWR0aCAvIDIsXG4gICAgICAgICAgdG9wOiBjeVBlcmNlbnQgKiBiYXNlUmVjdC5oZWlnaHQgKyBiYXNlUmVjdC50b3AgLSBoZWlnaHQgLyAyLFxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKHVwZGF0ZVJlZkxpbmVzU3RhdGUocmVmTGluZXNTdGF0ZSkpO1xuICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaCh1cGRhdGVOb2RlcyhuZXdOb2RlcykpO1xuICAgIH1cbiAgfVxuXG4gIG1vdmVFbmQoKTogdm9pZCB7XG4gICAgdGhpcy5wb2ludGVyU25hcHNob3QgPSBudWxsO1xuICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2gocmVzZXRSZWZMaW5lU3RhdGUoKSk7XG4gICAgdGhpcy5ub2Rlc1NuYXBzaG90LmNsZWFyKCk7XG4gIH1cblxuICBzaG93Qm9yZGVyKGlkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKGFkZEJvcmRlcmVkTm9kZXMoW2lkXSkpO1xuICB9XG5cbiAgcmVtb3ZlQm9yZGVyKGlkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuc2VsZWN0ZWQuaGFzKGlkKSkge1xuICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChyZW1vdmVCb3JkZXJlZE5vZGVzKFtpZF0pKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0UmVmTGluZVN0YXRlQnlEaXJlY3Rpb24oXG4gIGRpcmVjdGlvbjogSVJlZkxpbmVEaXJlY3Rpb24sXG4gIGJhc2VSZWN0OiBJRE9NUmVjdCxcbiAgcmVmZXJSZWN0OiBJRE9NUmVjdCxcbiAgZ2FwOiBudW1iZXJcbik6IElSZWZMaW5lU3RhdGUgJiB7IGJhc2U6IHsga2V5OiBrZXlvZiBJRE9NUmVjdDsgdmFsdWU6IG51bWJlciB9IH0ge1xuICByZXR1cm4gUkVGX0xJTkVfRElSRUNUSU9OX0NPTVBBUkVfTUFQW2RpcmVjdGlvbl1cbiAgICAubWFwKCh7IGJhc2VLZXksIHJlZmVyS2V5LCBiYXNlVmFsdWUgfSkgPT4gKHtcbiAgICAgIHN0YXRlOiBNYXRoLmFicyhiYXNlUmVjdFtiYXNlS2V5XSAtIHJlZmVyUmVjdFtyZWZlcktleV0pIDwgZ2FwLFxuICAgICAgcG9zaXRpb246IHJlZmVyUmVjdFtyZWZlcktleV0sXG4gICAgICBiYXNlOiBiYXNlVmFsdWUoYmFzZVJlY3QsIHJlZmVyUmVjdCksXG4gICAgfSkpXG4gICAgLmZpbmQoKGl0ZW0pID0+IGl0ZW0uc3RhdGUpO1xufVxuIiwiPGNlLWJveC1pdGVtXG4gICpuZ0Zvcj1cImxldCBub2RlIG9mIG5vZGVzJCB8IGFzeW5jOyB0cmFja0J5OiBub2RlTGlzdFRyYWNrQnlGblwiXG4gIGNlRHJhZ2dhYmxlXG4gIFtjZURyYWdEaXNhYmxlZF09XCJub2RlPy5sb2NrZWRcIlxuICAoY2VPblN0YXJ0KT1cIm1vdmVTdGFydCgkZXZlbnQsIG5vZGUpXCJcbiAgKGNlT25Nb3ZlKT1cIm1vdmluZygkZXZlbnQpXCJcbiAgKGNlT25TdG9wKT1cIm1vdmVFbmQoKVwiXG4gIFtub2RlXT1cIm5vZGVcIlxuICAocG9pbnRlcmVudGVyKT1cInNob3dCb3JkZXIobm9kZS5pZClcIlxuICAocG9pbnRlcmxlYXZlKT1cInJlbW92ZUJvcmRlcihub2RlLmlkKVwiXG4+PC9jZS1ib3gtaXRlbT5cbiJdfQ==